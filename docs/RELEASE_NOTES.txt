WeftEnd Alpha Update (Windows Shell + Trust Hardening)
Date: 2026-02-13
Scope: Deterministic artifact intake, baseline/compare workflows, operator-facing report cards, and Windows shell reliability hardening.
Liability scope: WeftEnd is an evidence and change-tracking engine, not a malware oracle or compliance guarantee.

Included
- 360 commit gate added:
- `npm run verify:360` now performs compile/test/proofcheck + deterministic replay + privacy lint + compare smoke.
- Gate now always writes evidence artifacts (`verify_360_receipt.json` and `verify_360_report.txt`) for PASS/PARTIAL/FAIL outcomes.
- Host precondition misses are explicit PARTIAL/SKIP evidence, not silent no-output aborts.
- Gate enforces docs/update discipline: code changes without operator-facing doc updates fail with `VERIFY360_DOC_SYNC_MISSING`.
- Gate now uses explicit state progression and two-phase output finalize (`stage -> finalize`) with `verify_360_output_manifest.json`.
- Gate receipt now carries deterministic evidence-chain links and idempotence key context for repeatable audit comparison.
- Gate idempotence is now enforced for duplicate-key replays:
- duplicate-key runs still emit full receipts/reports but suppress `out/verify_360/latest.txt` pointer advance to prevent double-apply state movement.
- receipt includes explicit idempotence mode and prior-run linkage (`NEW`/`REPLAY`/`PARTIAL`).
- Gate receipt now includes an explicit deterministic capability ledger:
- requested capabilities are enumerated per run, each marked `GRANTED` or `DENIED` with stable reason codes.
- unset capabilities are fail-closed as `DENIED` with `VERIFY360_CAPABILITY_UNSET`.
- Gate now emits a deterministic, versioned explain layer (`weftend.verify360Explain/0`) in receipt and report output.
- explanation text is fixed-table interpretation (verdict, idempotence mode, next action), not runtime-generated prose.
- Gate receipt/report now separate raw observations from conclusions:
- `observed` captures deterministic counts/presence/status summaries.
- `interpreted` captures verdict, reason set, and gate-state conclusions.
- Gate now guarantees fail-closed evidence artifacts even on unexpected internal exceptions.
- if normal gate output write fails, an emergency write path still emits receipt/report artifacts and suppresses pointer advance.
- Added controlled fault-injection hook for gate-path validation: `WEFTEND_360_FORCE_EXCEPTION=1`.
- Exception failure receipts now include stronger deterministic reason codes (exception-name token + explicit `VERIFY360_*` message token when present).
- Emergency write fallback now enforces no-orphan output integrity check.
- Added deterministic corridor harness command: `npm run verify:360:harness` (pass/replay/forced-exception sequence).
- Gate receipts now include deterministic state-path evidence (`stateHistory`) for pass/fail runs.
- Fail-closed exception path now includes explicit `VERIFY360_FAIL_CLOSED_AT_<STATE>` reason code.
- Harness assertions now validate newly-created run folders per phase (not just pointer changes), preventing false-green replay assumptions.
- State-path integrity now includes deterministic `stateHistoryDigest` mirrored in interpreted output.
- Verify writer now enforces payload consistency checks (state history/order, interpreted alignment, reason-code ordering) before output finalize.
- Fixed state-history mutation risk by snapshotting immutable state history into payloads before later stage transitions.
- Verify receipts now include explicit prior-run chain links (`historyLink`) with prior receipt file digest.
- Evidence chain mirrors prior-run link fields and harness now validates chain continuity and digest match across pass/replay/fail runs.
- verify:360 now supports `WEFTEND_360_OUT_ROOT` so harness and CI can run isolated history lanes.
- harness now uses isolated output root per run and enforces first run idempotence mode `NEW`.
- History chain now includes deterministic `historyLinkDigest`, mirrored in evidence-chain links and asserted by harness.
- Harness now also asserts stable-sorted receipt reason codes and capability-ledger set/status integrity.
- Added `verify:360:audit` command to validate history folder integrity (receipt/report/manifest, digests, and chain links).
- Added strict audit mode `verify:360:audit:strict` (fails on warnings/legacy gaps).
- Non-strict audit is backward-compatible and reports legacy gaps as warnings.
- `verify:360` now runs a built-in non-strict history audit pass and fails on audit errors (`VERIFY360_HISTORY_AUDIT_FAILED`).
- Legacy history warnings are surfaced deterministically (`VERIFY360_HISTORY_AUDIT_WARNINGS_PRESENT`) without forcing strict-mode failure by default.
- New explicit proof-only shadow audit lane:
- `weftend shadow-audit <request.json>` validates bounded schema/privacy constraints and emits deterministic `weftend.shadowAudit.result/0` counts + reason families (no implicit storage/export side effects).
- Shadow-audit hardening:
- proof-only contract tests now assert no raw event/stream/request echo in outputs.
- `streamNonce` is schema-validated but intentionally excluded from result payloads.
- Added explicit shadow-audit contract checks for WARN-vs-DENY threshold behavior and deterministic tail truncation (highest-seq drop under bounds).
- Added fixture-backed shadow-audit contract tests (`tests/fixtures/shadow_audit`) to pin deterministic output shape and reason ordering.
- Shadow-audit fixture suite now includes capability anomaly coverage for WARN vs threshold-driven DENY (`attemptedWithoutRequest`, `allowedWithoutEvidence`, `inconsistent`).
- Shadow-audit fixture suite now includes sequence anomaly coverage for WARN vs threshold-driven DENY (`missing`, `extra`, `reordered`, `duplicate`).
- Shadow-audit fixture suite now also pins schema-invalid `streamNonce` and bounds-exceeded behavior (event count cap and per-event key cap).
- Shadow-audit privacy guard now treats key aliases like `user_id` / `session-id` as forbidden identifier fields (fixture-pinned).
- Shadow-audit privacy contracts now also pin hostname-in-value blocking and time-key alias blocking (`time_ms`), while preserving `capId` dotted tags (for example `cap.read`).
- Shadow-audit fixture suite now pins tartarus kind-count bounds behavior (`max 32 kinds`, deterministic truncation, `SHADOW_AUDIT_BOUNDS_EXCEEDED`).
- Shadow-audit policy schema is now strict for threshold keys: unknown `policy.denyThresholds` keys fail closed with fixture-pinned `SHADOW_AUDIT_SCHEMA_INVALID`.
- Shadow-audit schema strictness expanded: unknown request/stream/event fields now fail closed (fixture-pinned contract coverage).
- Shadow-audit fixture suite now explicitly pins unknown stream-field fail-closed behavior (`SHADOW_AUDIT_SCHEMA_INVALID`) alongside request/event unknown-field contracts.
- Shadow-audit policy schema strictness now also fails closed when `policy` is present but not an object (fixture-pinned `SHADOW_AUDIT_SCHEMA_INVALID`).
- Universal artifact adapter expansion (analysis-only, deterministic, fail-closed):
- New safe-run adapter flags: `--adapter auto|none|archive|package|extension|iac|cicd|document|container|image|scm|signature`
- Optional repeatable plugin flag: `--enable-plugin <name>` (explicit local plugin use only)
- Unknown `--enable-plugin` names now fail closed with `ADAPTER_PLUGIN_UNKNOWN` (no silent plugin-name fallback/ignore).
- Unknown plugin names are validated before adapter routing, so `ADAPTER_PLUGIN_UNKNOWN` also fails closed under `--adapter none`.
- Duplicate plugin names now fail closed (`INPUT_INVALID` at CLI and `ADAPTER_PLUGIN_DUPLICATE` at adapter runtime) instead of being silently de-duplicated.
- Adapter plugin strictness tests now pin this behavior under both `--adapter none` and `--adapter auto` (including auto no-class-match cases).
- `safe-run --enable-plugin` now fails closed when plugin value is missing (`INPUT_INVALID`) instead of silently ignoring malformed flags.
- `safe-run` now rejects unsupported flags with `INPUT_INVALID` (for example typoed flags like `--adpater`) instead of silently ignoring them.
- `safe-run` now fails closed for unexpected extra positional arguments and for conflicting `--execute` + `--withhold-exec|--no-exec` flag combinations.
- `safe-run` now fails closed when known value flags are provided without values (for example `--adapter` with no value) instead of silently falling back.
- CLI flag parsing now preserves missing-value semantics when a value flag is followed by another flag token (for example `--out --adapter ...`) instead of mis-parsing the next flag as a value.
- `safe-run` now fails closed on duplicate singleton flags (for example repeated `--adapter` or repeated `--out`) instead of silently using the last value.
- `safe-run --adapter none` now fails closed when plugin flags are provided (`ADAPTER_PLUGIN_UNUSED`) instead of silently ignoring plugin config.
- `safe-run` now fails closed with `ADAPTER_PLUGIN_UNUSED` when plugin flags are provided for non-plugin routes (for example `--adapter auto` no-class-match or explicit non-plugin adapters like `document`).
- `safe-run` archive plugin routing is now format-strict: inapplicable plugin declarations fail closed with `ADAPTER_PLUGIN_UNUSED` (for example `zip + tar`, `tgz + 7z`) instead of silently no-op.
- Explicit `--adapter cicd` routing is now strict and fails closed on non-CI/CD inputs (`CICD_UNSUPPORTED_FORMAT`) instead of silently classifying generic IaC text as CI/CD.
- Explicit `--adapter extension` routing is now strict and fails closed when `manifest.json` is missing or invalid (`EXTENSION_MANIFEST_MISSING` / `EXTENSION_MANIFEST_INVALID`) instead of producing partial extension summaries.
- Explicit `--adapter image` routing is now strict and fails closed when extension/header evidence mismatches (`IMAGE_FORMAT_MISMATCH`) instead of returning partial-success image summaries.
- Explicit `--adapter package` routing is now strict for `.exe` and ZIP-backed package containers (`.msix/.nupkg/.whl/.jar`), failing closed on extension/container mismatch (`PACKAGE_FORMAT_MISMATCH`) instead of returning partial package summaries.
- Explicit `--adapter package` routing strictness now also covers `.deb` and `.rpm`, failing closed on invalid container/header evidence (`PACKAGE_FORMAT_MISMATCH`) instead of returning partial package summaries.
- Explicit `--adapter package` routing strictness now also covers `.msi`, failing closed on invalid CFB header evidence (`PACKAGE_FORMAT_MISMATCH`) instead of returning partial package summaries.
- Explicit `--adapter package` routing strictness now also covers `.appimage`, `.pkg`, and `.dmg`, failing closed on invalid header/trailer evidence (`PACKAGE_FORMAT_MISMATCH`) instead of returning partial package summaries.
- Explicit `--adapter container` routing now fails closed on invalid SBOM JSON (`CONTAINER_SBOM_INVALID`) for SBOM-named inputs instead of returning partial container summaries.
- Explicit `--adapter container` routing now also fails closed on invalid OCI `index.json` (`CONTAINER_INDEX_INVALID`) for OCI-layout inputs instead of returning partial container summaries.
- Explicit `--adapter document` routing for `.docm/.xlsm` now fails closed on extension/container mismatch (`DOC_FORMAT_MISMATCH`) instead of returning partial document summaries.
- New adapter discovery command: `weftend adapter list`
- Additive receipt/summary surface:
- `safe_run_receipt.json` optional `adapter` metadata block
- `contentSummary.adapterSignals` optional deterministic adapter signal block
- Optional adapter artifacts in run output:
- `analysis/adapter_summary_v0.json`
- `analysis/adapter_findings_v0.json`
- Package/extension ZIP metadata extraction deepened for deterministic manifest signals:
- `.msix/.nupkg/.whl/.jar` manifest text hints are now extracted from ZIP entries (bounded, analysis-only).
- `.crx/.vsix` now parse `manifest.json` when present in ZIP payloads (permissions/content scripts/update URL domain hints).
- `.xpi` extension bundles are now supported through the same deterministic ZIP-manifest path.
- Linux package coverage added to package adapter:
- `.deb` now parses deterministic AR entry metadata (bounded, no extraction/exec).
- `.rpm` now captures deterministic lead/header/script/signing hint counters from local bytes only.
- `.appimage` now captures deterministic ELF/runtime header hints (analysis-only; execution withheld).
- Archive/package tar coverage expanded:
- `.tar.xz/.txz` now follow explicit tar-plugin, fail-closed handling in archive/package lanes.
- macOS installer coverage added to package adapter:
- `.pkg` now captures deterministic XAR header and script/permission hint counters.
- `.dmg` now captures deterministic trailer marker hints (`koly`) without mounting.
- Document adapter deepened for `.docm/.xlsm`:
- ZIP structure + relationships are inspected deterministically for macro/embed/external-link indicators.
- IaC/CI adapter extraction deepened:
- Deterministic action reference parsing now distinguishes pinned commit/digest refs from unpinned refs.
- Remote module/source indicators and external runner signals are counted with structured counters in adapter summary output.
- Container adapter extraction deepened:
- OCI layout counts now include manifest and blob counts.
- Container tarball detection can use tar entry metadata (`manifest.json` + `repositories`) for local tar inputs.
- SBOM JSON parsing now emits bounded package/component counts when present.
- Signature/cert adapter extraction deepened:
- Deterministic PEM block counting for certificate/PKCS7/signature material.
- Binary OID hint counts added for CMS signedData and timestamp EKU indicators.
- SCM/source evidence adapter extraction deepened:
- Deterministic repo counters now include tree entry count, branch/tag ref counts, detached HEAD indicator, and working-tree entry count.
- SCM adapter now emits deterministic worktree state evidence (staged/unstaged/untracked counts) and `SCM_WORKTREE_DIRTY` when local repo state is dirty.
- SCM fallback hardening:
- When `git` commands are unavailable/failing, adapter now parses native `.git` reference material (`HEAD`, loose refs, packed-refs) deterministically for source evidence.
- Image adapter extraction deepened:
- Deterministic header evidence now includes ISO PVD, VHD footer, VHDX signature, QCOW2 magic/version, and VMDK descriptor/sparse-magic hints.
- Package/installer signing evidence deepened:
- Deterministic local signing hints now include PE cert-table presence for `.exe` and signature-entry hints for `.msix/.nupkg/.whl/.jar`.
- New package reason code support: `PACKAGE_SIGNING_INFO_PRESENT` alongside existing unavailable paths.
- Container scan now emits adapter metadata/signals plus adapter artifacts using the same deterministic contract as safe-run adapters.
- Container scan evidence remains local-only inspect data and excludes unstable fields (timestamps/raw env/path values).
- Wave coverage now includes:
- Wave 1: archives, packages/installers, extensions
- Wave 2 baseline: IaC/CICD and document risk signal extraction
- Wave 3 baseline: container/source/signature/image evidence lanes
- Core/runtime trust hardening sweep applied in release scope (digest/trust/runtime path updates, host verification flow updates, and aligned fixture/contract updates).
- Builder integration surface explicitly supported: `weftend export-json <outRoot> --format normalized_v0` emits deterministic `weftend.normalizedSummary/0` output for downstream tools (see docs/POWERED_BY_WEFTEND.md).
- Shortcut scan accuracy fix for .lnk targets: report and compare now resolve the actual target script/program instead of effectively classifying the shell host.
- Baseline decision flow hardening for CHANGED/BLOCKED runs in Launchpad paths (accept/decline prompt reliability and gating behavior).
- Native report viewer workflow is the default operator path; Notepad is no longer the primary report UX.
- Report viewer startup hardened: host console launches hidden while the report viewer opens in normal visible state for review.
- Launchpad History UX improvements: direct View Report action and keyboard open behavior (double-click/Enter).
- New bind/unbind right-click flow:
- Bind to WeftEnd and Unbind from WeftEnd verbs for files, shortcuts, and folders.
- .lnk rewrap mode preserves icon and stores an original shortcut backup for safe restoration.
- Legacy metadata compatibility fixes prevent stale-state and strict-mode unbind failures.
- Shell integration simplification: only WeftEnd Launchpad and WeftEnd Download shortcuts are installed by default.
- Structured report artifacts available for UI and automation:
- report_card_v0.json
- report_card.txt

Validation
- npm run compile --silent: pass
- node dist/src/tools/windows_shell_assets.test.js: pass
- node dist/src/tools/greenteam/release_artifacts_present.test.js: pass
- npm test: pass (on release hardening sweep state)

Not included
- Malware scoring or reputation.
- Cloud analysis or telemetry.
- Automatic execution of native binaries outside explicit gated flows.
- Automatic trust root generation.

Operator notes
- Standard and portable release zips each ship with a .sha256 file for verification.
- Use published release zips, not GitHub auto-generated source archives, for operator installs.
- STATUS SAME can occur after a changed run if that changed state was accepted as the current baseline.
- See docs/DISCLAIMER.md for legal scope and non-guarantees.
