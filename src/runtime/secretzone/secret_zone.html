<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WeftEnd Secret Zone (local)</title>
  </head>
  <body>
    <div id="status" style="font-family: Arial, sans-serif; font-size: 14px; padding: 12px; color: #1f1b16;">
      Secret Zone: loading...
    </div>
    <script>
      (() => {
        let port = null;
        let seq = 1;
        const statusEl = document.getElementById("status");

        const notifyReady = () => {
          try {
            window.parent.postMessage({ kind: "secretzone.ready" }, "*");
            if (statusEl) statusEl.textContent = "Secret Zone: ready";
          } catch {}
        };

        const handlePortMessage = (msg) => {
          if (!msg || !port) return;
          if (msg.kind === "consent.request") {
            const consentSeq = seq++;
            const consentId = `consent-${consentSeq}`;
            port.postMessage({
              kind: "consent.result",
              reqId: msg.reqId,
              ok: true,
              consent: {
                consentId,
                action: msg.action,
                subject: msg.subject,
                scope: msg.scope,
                issuerId: "user:local",
                seq: consentSeq,
              },
              executionMode: msg.executionMode,
              planHash: msg.planHash,
              sessionNonce: msg.sessionNonce,
            });
          }
        };

        window.addEventListener("message", (evt) => {
          if (evt.data && evt.data.kind === "init_port" && evt.ports && evt.ports[0]) {
            port = evt.ports[0];
            port.onmessage = (e) => handlePortMessage(e.data);
            if (typeof port.start === "function") port.start();
            return;
          }
          if (evt.data && evt.data.kind === "secretzone.ping") notifyReady();
        });

        notifyReady();
      })();
    </script>
  </body>
</html>
